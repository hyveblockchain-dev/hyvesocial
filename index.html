<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hyve Social - Decentralized Social Media</title>
  
  <!-- Ethers.js for Web3 Integration -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  
  <!-- WalletConnect for Mobile Wallets -->
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
      color: #fff;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .container {
      max-width: 500px;
      width: 90%;
      text-align: center;
      padding: 3rem;
      background: rgba(26, 26, 26, 0.8);
      border-radius: 24px;
      border: 1px solid #333;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
    }

    .logo {
      margin-bottom: 2rem;
    }

    .logo-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      box-shadow: 0 8px 24px rgba(245, 158, 11, 0.4);
      margin-bottom: 1rem;
      position: relative;
    }

    .logo-icon::after {
      content: '';
      position: absolute;
      top: 6px;
      left: 6px;
      right: 6px;
      bottom: 6px;
      border-radius: 50%;
      border: 3px solid rgba(255, 255, 255, 0.3);
    }

    .logo-text {
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 1rem;
    }

    .tagline {
      font-size: 1.125rem;
      color: #888;
      margin-bottom: 3rem;
      line-height: 1.6;
    }

    .connect-btn {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
      color: #000;
      border: none;
      padding: 1rem 2.5rem;
      border-radius: 50px;
      font-size: 1.125rem;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 16px rgba(245, 158, 11, 0.4);
      width: 100%;
      max-width: 300px;
    }

    .connect-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(245, 158, 11, 0.6);
    }

    .connect-btn:active {
      transform: translateY(0);
    }

    .connect-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .features {
      margin-top: 3rem;
      display: grid;
      gap: 1.5rem;
      text-align: left;
    }

    .feature {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: rgba(42, 42, 42, 0.5);
      border-radius: 12px;
      border: 1px solid #333;
    }

    .feature-icon {
      font-size: 1.5rem;
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .feature-text {
      flex: 1;
    }

    .feature-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: #fff;
    }

    .feature-desc {
      font-size: 0.875rem;
      color: #888;
    }

    .status-message {
      margin-top: 1.5rem;
      padding: 1rem;
      border-radius: 12px;
      font-size: 0.875rem;
      display: none;
    }

    .status-message.show {
      display: block;
    }

    .status-message.info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: #60a5fa;
    }

    .status-message.success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: #10b981;
    }

    .status-message.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }

    .footer {
      margin-top: 3rem;
      font-size: 0.875rem;
      color: #666;
    }

    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(0, 0, 0, 0.3);
      border-top-color: #000;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-right: 0.5rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Background animation */
    .bg-animation {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      opacity: 0.1;
    }

    .bg-animation::before,
    .bg-animation::after {
      content: '';
      position: absolute;
      width: 500px;
      height: 500px;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
      border-radius: 50%;
      filter: blur(100px);
    }

    .bg-animation::before {
      top: -250px;
      left: -250px;
      animation: float 20s ease-in-out infinite;
    }

    .bg-animation::after {
      bottom: -250px;
      right: -250px;
      animation: float 25s ease-in-out infinite reverse;
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0); }
      50% { transform: translate(100px, 100px); }
    }
  </style>
</head>
<body>
  <div class="bg-animation"></div>
  
  <div class="container">
    <div class="logo">
      <div class="logo-icon">üêù</div>
      <div class="logo-text">Hyve Social</div>
    </div>

    <p class="tagline">
      The first truly decentralized social media.<br>
      Own your data. Own your network.
    </p>

    <button id="connectBtn" class="connect-btn" onclick="connectWallet()">
      Connect Wallet
    </button>

    <div id="statusMessage" class="status-message"></div>

    <div class="features">
      <div class="feature">
        <div class="feature-icon">üîí</div>
        <div class="feature-text">
          <div class="feature-title">Your Data, Your Control</div>
          <div class="feature-desc">All data stored on blockchain. No corporate servers.</div>
        </div>
      </div>

      <div class="feature">
        <div class="feature-icon">üíé</div>
        <div class="feature-text">
          <div class="feature-title">True Ownership</div>
          <div class="feature-desc">Your posts are NFTs. You own them forever.</div>
        </div>
      </div>

      <div class="feature">
        <div class="feature-icon">üö´</div>
        <div class="feature-text">
          <div class="feature-title">Censorship Resistant</div>
          <div class="feature-desc">No one can delete your content or ban your account.</div>
        </div>
      </div>
    </div>

    <div class="footer">
      Powered by Hyve Blockchain
    </div>
  </div>

  <script>
    // Contract configuration
    const CONTRACT_ADDRESS = "0x270B4265f15361E2A04a78A8E00443aB73668202";
    const CHAIN_ID = 9200;
    const CHAIN_NAME = "Hyve Blockchain";
    const RPC_URL = "https://rpc.hyvechain.com";

    // Contract ABI (only the functions we need for login)
    const CONTRACT_ABI = [
      {
        "inputs": [{"internalType": "address", "name": "user", "type": "address"}],
        "name": "profileExistsForUser",
        "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [{"internalType": "address", "name": "user", "type": "address"}],
        "name": "getProfile",
        "outputs": [{
          "components": [
            {"internalType": "string", "name": "username", "type": "string"},
            {"internalType": "string", "name": "bio", "type": "string"},
            {"internalType": "string", "name": "profileImageHash", "type": "string"},
            {"internalType": "uint256", "name": "createdAt", "type": "uint256"},
            {"internalType": "uint256", "name": "followerCount", "type": "uint256"},
            {"internalType": "uint256", "name": "followingCount", "type": "uint256"},
            {"internalType": "bool", "name": "exists", "type": "bool"}
          ],
          "internalType": "struct HyveSocial.Profile",
          "name": "",
          "type": "tuple"
        }],
        "stateMutability": "view",
        "type": "function"
      }
    ];

    // Check if already connected on page load
    window.addEventListener('load', async () => {
      if (typeof window.ethereum !== 'undefined') {
        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
        if (accounts.length > 0) {
          // Already connected, auto-login
          await connectWallet();
        }
      }
    });

    // Connect wallet and check profile
    async function connectWallet() {
      const btn = document.getElementById('connectBtn');
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      try {
        // DESKTOP: Use MetaMask extension
        if (!isMobile) {
          if (typeof window.ethereum === 'undefined') {
            showStatus('Please install MetaMask to continue!', 'error');
            setTimeout(() => {
              window.open('https://metamask.io/download/', '_blank');
            }, 2000);
            return;
          }

          btn.disabled = true;
          btn.innerHTML = '<span class="spinner"></span>Connecting...';
          showStatus('Requesting wallet connection...', 'info');

          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          const userAddress = accounts[0];
          showStatus('Wallet connected! Checking network...', 'info');

          const provider = new ethers.providers.Web3Provider(window.ethereum);
          const network = await provider.getNetwork();

          if (network.chainId !== CHAIN_ID) {
            showStatus('Switching to Hyve Blockchain...', 'info');
            await switchToHyveChain();
          }

          // Save wallet type
          sessionStorage.setItem('walletType', 'metamask');
          
          await checkProfileAndRedirect(provider, userAddress);
        } 
        // MOBILE: Use MetaMask mobile deep link
        else {
          // Check if we're in MetaMask browser
          if (typeof window.ethereum !== 'undefined') {
            // Already in MetaMask browser, use it directly
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Connecting...';
            showStatus('Connecting to wallet...', 'info');

            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            const userAddress = accounts[0];

            const provider = new ethers.providers.Web3Provider(window.ethereum);
            sessionStorage.setItem('walletType', 'metamask');
            
            await checkProfileAndRedirect(provider, userAddress);
          } else {
            // Not in wallet browser, redirect to MetaMask mobile
            const currentUrl = window.location.href;
            const metamaskDeepLink = `https://metamask.app.link/dapp/${currentUrl.replace('https://', '').replace('http://', '')}`;
            
            showStatus('Redirecting to MetaMask...', 'info');
            setTimeout(() => {
              window.location.href = metamaskDeepLink;
            }, 1000);
            return;
          }
        }
        
      } catch (error) {
        console.error('Connection error:', error);
        btn.disabled = false;
        btn.innerHTML = 'Connect Wallet';
        
        if (error.code === 4001 || error.message.includes('User closed modal')) {
          showStatus('Connection cancelled', 'error');
        } else {
          showStatus('Connection failed: ' + error.message, 'error');
        }
      }
    }

    async function checkProfileAndRedirect(provider, userAddress) {
      const btn = document.getElementById('connectBtn');
      
      try {
        // Check if user has a profile
        showStatus('Checking your profile...', 'info');
        const signer = provider.getSigner();
        const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
        
        const profileExists = await contract.profileExistsForUser(userAddress);

        if (profileExists) {
          // Profile exists, get profile data
          const profile = await contract.getProfile(userAddress);
          
          // Store user data in sessionStorage
          sessionStorage.setItem('userAddress', userAddress);
          sessionStorage.setItem('username', profile.username);
          sessionStorage.setItem('bio', profile.bio);
          sessionStorage.setItem('profileImageHash', profile.profileImageHash);
          
          showStatus('Welcome back, ' + profile.username + '! Redirecting...', 'success');
          
          // Redirect to main app
          setTimeout(() => {
            window.location.href = '/app.html';
          }, 1500);
        } else {
          // No profile, redirect to profile creation
          sessionStorage.setItem('userAddress', userAddress);
          showStatus('No profile found. Creating your profile...', 'info');
          
          setTimeout(() => {
            window.location.href = '/create-profile.html';
          }, 1500);
        }

      } catch (error) {
        console.error('Connection error:', error);
        
        let errorMsg = 'Failed to connect';
        if (error.code === 4001) {
          errorMsg = 'Connection rejected. Please try again.';
        } else if (error.message) {
          errorMsg = error.message;
        }
        
        showStatus(errorMsg, 'error');
        
        // Re-enable button
        btn.disabled = false;
        btn.textContent = 'Connect Wallet';
      }
    }

    // Switch to Hyve Chain
    async function switchToHyveChain() {
      try {
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: '0x23F0' }], // 9200 in hex
        });
      } catch (switchError) {
        // Chain not added to MetaMask
        if (switchError.code === 4902) {
          try {
            await window.ethereum.request({
              method: 'wallet_addEthereumChain',
              params: [{
                chainId: '0x23F0',
                chainName: CHAIN_NAME,
                nativeCurrency: {
                  name: 'HYVE',
                  symbol: 'HYVE',
                  decimals: 18
                },
                rpcUrls: [RPC_URL],
                blockExplorerUrls: ['https://explorer.hyvechain.com']
              }]
            });
          } catch (addError) {
            throw new Error('Failed to add Hyve Chain to MetaMask');
          }
        } else {
          throw switchError;
        }
      }
    }

    // Show status message
    function showStatus(message, type) {
      const statusMsg = document.getElementById('statusMessage');
      statusMsg.textContent = message;
      statusMsg.className = 'status-message show ' + type;
    }
  </script>


</body>
</html>
